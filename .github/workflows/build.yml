name: Build ImmortalWrt Docker Image

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型 (Standard 为纯净版, OpenClash 为集成版)'
        required: true
        default: 'openclash'
        type: choice
        options:
          - standard
          - openclash
      kernel_version:
        description: '选择 Clash Meta 内核版本 (仅对 OpenClash 版有效)'
        required: true
        default: 'v1-smart'
        type: choice
        options:
          - v1
          - v2
          - v3
          - v1-smart
          - v2-smart
          - v3-smart

env:
  IM_VERSION: "24.10.1"
  TARGET_BOARD: "x86"
  TARGET_SUBTARGET: "64"
  OPENCLASH_REPO: "vernesong/OpenClash"

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize Environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -y update
          sudo -E apt-get -y install build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc rsync wget unzip python3 qemu-utils zstd genisoimage

      - name: Smart Download ImageBuilder
        run: |
          BASE_URL="https://downloads.immortalwrt.org/releases/${IM_VERSION}/targets/${TARGET_BOARD}/${TARGET_SUBTARGET}"
          wget -O sha256sums "$BASE_URL/sha256sums"
          IB_FILENAME=$(grep "imagebuilder" sha256sums | grep "Linux-x86_64" | head -n 1 | awk '{print $2}' | tr -d '*')
          wget -O imagebuilder.tar "$BASE_URL/$IB_FILENAME"
          mkdir -p imagebuilder
          if [[ "$IB_FILENAME" == *".zst" ]]; then
            tar -I zstd -xf imagebuilder.tar -C imagebuilder --strip-components=1
          else
            tar -xf imagebuilder.tar -C imagebuilder --strip-components=1
          fi

      - name: Prepare Clash Kernel
        if: github.event.inputs.build_type == 'openclash'
        run: |
          mkdir -p imagebuilder/files/etc/openclash/core
          KERNEL_OPT="${{ inputs.kernel_version }}"
          BASE_URL="https://raw.githubusercontent.com/vernesong/OpenClash/core/master"
          if [[ "$KERNEL_OPT" == *"-smart"* ]]; then
            VER=${KERNEL_OPT%-smart}
            DOWNLOAD_URL="${BASE_URL}/smart/clash-linux-amd64-${VER}.tar.gz"
          else
            DOWNLOAD_URL="${BASE_URL}/meta/clash-linux-amd64-${KERNEL_OPT}.tar.gz"
          fi
          wget -O kernel.tar.gz "$DOWNLOAD_URL"
          tar -xzf kernel.tar.gz
          mv clash* imagebuilder/files/etc/openclash/core/clash_meta
          chmod +x imagebuilder/files/etc/openclash/core/clash_meta

      - name: Download Latest OpenClash
        if: github.event.inputs.build_type == 'openclash'
        run: |
          mkdir -p imagebuilder/packages/custom
          OC_URL=$(curl -sL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${OPENCLASH_REPO}/releases" | \
            grep "browser_download_url" | \
            grep "luci-app-openclash" | \
            grep ".ipk" | \
            head -n 1 | \
            cut -d '"' -f 4)
          wget -P imagebuilder/packages/custom "$OC_URL"

      - name: Generate Rootfs
        working-directory: ./imagebuilder
        run: |
          # 根据构建类型处理软件包列表
          if [[ "${{ github.event.inputs.build_type }}" == "standard" ]]; then
            # 移除 OpenClash 及其特有依赖 (ruby, ruby-yaml)
            PACKAGES_LIST=$(grep -vE '^\s*#' ../packages.txt | grep -vE 'ruby|luci-app-openclash' | tr -d '\r' | tr '\n' ' ')
          else
            PACKAGES_LIST=$(grep -vE '^\s*#' ../packages.txt | tr -d '\r' | tr '\n' ' ')
          fi

          echo "Final Packages List: $PACKAGES_LIST"

          # 强制配置为仅生成 rootfs.tar.gz
          sed -i '/CONFIG_TARGET_ROOTFS_EXT4FS/d' .config
          sed -i '/CONFIG_TARGET_ROOTFS_SQUASHFS/d' .config
          sed -i '/CONFIG_ISO_IMAGES/d' .config
          sed -i '/CONFIG_VHDX_IMAGES/d' .config
          sed -i '/CONFIG_VMDK_IMAGES/d' .config
          sed -i '/CONFIG_VDI_IMAGES/d' .config
          sed -i '/CONFIG_QCOW2_IMAGES/d' .config
          sed -i '/CONFIG_TARGET_IMAGES_GZIP/d' .config

          cat <<EOF >> .config
          # CONFIG_TARGET_ROOTFS_EXT4FS is not set
          # CONFIG_TARGET_ROOTFS_SQUASHFS is not set
          # CONFIG_ISO_IMAGES is not set
          # CONFIG_VHDX_IMAGES is not set
          # CONFIG_VMDK_IMAGES is not set
          # CONFIG_VDI_IMAGES is not set
          # CONFIG_QCOW2_IMAGES is not set
          CONFIG_TARGET_ROOTFS_TARGZ=y
          EOF

          make image PROFILE="generic" PACKAGES="$PACKAGES_LIST" FILES="files"

      - name: Prepare Docker Context
        run: |
          find imagebuilder/bin/targets/${TARGET_BOARD}/${TARGET_SUBTARGET} -name "*rootfs.tar.gz" -exec mv {} ./rootfs.tar.gz \;

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        run: |
          DATE_TAG=$(TZ='Asia/Shanghai' date +%Y%m%d%H%M)
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # 根据构建类型动态设置变量
          if [[ "${{ github.event.inputs.build_type }}" == "standard" ]]; then
            CURRENT_IMAGE_NAME="immortalwrt"
            VERSION_TAG="${{ env.IM_VERSION }}"
            TITLE="ImmortalWrt Docker Image"
            DESC="基于 ImmortalWrt 官方 ImageBuilder 构建的纯净版 Docker 镜像"
            PORTS="80 443"
          else
            CURRENT_IMAGE_NAME="immortalwrt-openclash"
            VERSION_TAG="openclash-${DATE_TAG}"
            TITLE="ImmortalWrt OpenClash Docker"
            DESC="基于 ImmortalWrt 构建并集成 OpenClash 及其核心依赖的 Docker 镜像"
            PORTS="80 443 53/udp 53/tcp 7890 7891 7892 7893 7894 7895"
          fi

          FULL_IMAGE_PATH="ghcr.io/${REPO_OWNER}/${CURRENT_IMAGE_NAME}"

          docker buildx build \
            --platform linux/amd64 \
            --provenance=false \
            --build-arg IMAGE_TITLE="${TITLE}" \
            --build-arg IMAGE_DESC="${DESC}" \
            --build-arg EXPOSE_PORTS="${PORTS}" \
            --tag "${FULL_IMAGE_PATH}:latest" \
            --tag "${FULL_IMAGE_PATH}:${VERSION_TAG}" \
            --file docker/Dockerfile \
            --push \
            .

      - name: Delete Old Images
        uses: actions/delete-package-versions@v5
        continue-on-error: true
        with:
          package-name: |
            immortalwrt
            immortalwrt-openclash
          package-type: 'container'
          min-versions-to-keep: 3